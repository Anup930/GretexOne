<!-- V1.2 -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <base target="_top">
  <title>Gretex One - Credit Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

  <style>
    :root {
      --purple-1: #3a3f9d;
      --purple-2: #5b6fe0;
      --card-bg: #fdfdff;
      --shadow-med: 0 6px 18px rgba(0,0,0,0.06);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Poppins', sans-serif; background: #f0f4f8; padding: 40px; color: #333; }
    .back-link { font-size: 1rem; text-decoration: none; color: #4a5a9b; font-weight: 500; margin-bottom: 20px; display: inline-block; }
    .app-content { max-width: 1200px; margin: 0 auto; }
    .dashboard-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
    .dashboard-header h1 { font-size:1.8rem; font-weight:600; }
    .btn-primary { background: linear-gradient(90deg, var(--purple-2), var(--purple-1)); color:#fff; border:none; padding:10px 20px; border-radius:8px; font-weight:600; cursor:pointer; }
    .card-module { background: var(--card-bg); border-radius:16px; box-shadow:var(--shadow-med); overflow:hidden; }
    .card-module-header { padding:24px 32px; border-bottom:1px solid #e9eef2; }
    .credit-card-visual { width:300px; height:180px; background: linear-gradient(135deg,#4c5bd6,#384090); border-radius:12px; padding:20px; color:#fff; display:flex; flex-direction:column; justify-content:space-between; box-shadow: 0 10px 30px rgba(50,60,140,0.3); }
    .card-module-body { padding:24px 32px; }
    .bill-section { margin-bottom:24px; }
    .bill-section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .btn-secondary { background:#eef2f7; border:1px solid #d8e0e7; padding:8px 16px; border-radius:6px; cursor:pointer; }
    .btn-paid { background:#e0f2f1; color:#00695c; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }
    .bill-table { width:100%; border-collapse:collapse; font-size:14px; }
    .bill-table th, .bill-table td { padding:12px 16px; text-align:left; border-bottom:1px solid #eef2f7; }
    .no-bills-message { padding:20px; text-align:center; color:#777; background:#f9f9f9; border-radius:8px; }
    .loading-spinner { text-align:center; padding:50px; font-size:1.2rem; color:#555; }
    /* Modal */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal-overlay.visible { display:flex; }
    .modal-content { background:#fff; border-radius:12px; padding:24px; width:100%; max-width:520px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
    .form-group { margin-bottom:12px; }
    .form-group input, .form-group label { width:100%; display:block; }
    input[type="text"], input[type="number"], input[type="date"], input[type="file"] { padding:8px 10px; border:1px solid #d8e0e7; border-radius:6px; }
    .modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
  </style>
</head>
<body>

  <a href="App_access.html" class="back-link">← Back to Home</a>

  <div class="app-content">
    <div class="dashboard-header">
      <h1>Credit Card Management</h1>
      <button class="btn-primary" id="add-new-card-btn">
        <span class="material-icons-outlined" style="vertical-align:middle; margin-right:6px;">add_card</span>
        Add New Card
      </button>
    </div>

    <div id="card-dashboard">
      <div id="loading-spinner" class="loading-spinner">Loading your card dashboard...</div>
    </div>
  </div>

  <!-- Add Card Modal -->
  <div class="modal-overlay" id="add-card-modal">
    <div class="modal-content">
      <h2>Add New Credit Card</h2>
      <form id="add-card-form">
        <div class="form-group">
          <label for="card-issuer">Card Issuer (e.g., HDFC Bank)</label>
          <input type="text" id="card-issuer" required>
        </div>
        <div class="form-group">
          <label for="card-last-4">Last 4 Digits</label>
          <input type="text" id="card-last-4" maxlength="4" pattern="\d{4}" required>
        </div>
        <div class="form-group">
          <label for="card-name">Name on Card</label>
          <input type="text" id="card-name" required>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" data-close="add-card-modal">Cancel</button>
          <button type="submit" class="btn-primary" id="save-card-btn">Save Card</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Bill Modal -->
  <div class="modal-overlay" id="add-bill-modal">
    <div class="modal-content">
      <h2>Add New Bill</h2>
      <form id="add-bill-form">
        <input type="hidden" id="bill-card-id">
        <div class="form-group"><label for="bill-number">Bill Number</label><input id="bill-number" required></div>
        <div class="form-group"><label for="bill-date">Bill Date</label><input id="bill-date" type="date" required></div>
        <div class="form-group"><label for="bill-due-date">Due Date</label><input id="bill-due-date" type="date" required></div>
        <div class="form-group"><label for="bill-amount">Amount</label><input id="bill-amount" type="number" step="0.01" required></div>
        <div class="form-group"><label for="bill-attachment">Attachment</label><input id="bill-attachment" type="file" accept=".pdf,image/*"></div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" data-close="add-bill-modal">Cancel</button>
          <button type="submit" class="btn-primary" id="save-bill-btn">Save Bill</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Payment Modal -->
  <div class="modal-overlay" id="add-payment-modal">
    <div class="modal-content">
      <h2>Mark Bill as Paid</h2>
      <form id="add-payment-form">
        <input type="hidden" id="payment-bill-id">
        <div class="form-group"><label for="payment-txn-no">Transaction No.</label><input id="payment-txn-no" required></div>
        <div class="form-group"><label for="payment-date">Pay Date</label><input id="payment-date" type="date" required></div>
        <div class="form-group"><label for="payment-amount">Pay Amount</label><input id="payment-amount" type="number" step="0.01" required></div>
        <div class="form-group"><label for="payment-attachment">Payment Attachment</label><input id="payment-attachment" type="file" accept=".pdf,image/*"></div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" data-close="add-payment-modal">Cancel</button>
          <button type="submit" class="btn-primary" id="save-payment-btn">Save Payment</button>
        </div>
      </form>
    </div>
  </div>

<script>
  // When served via Apps Script, the page origin will be the Apps Script web app.
  // Use the same web app URL for fetch calls (doPost); since the page is served by the same origin,
  // CORS will not block requests. We'll use a relative endpoint at the script host:
  // However Apps Script web app root is different; safest is to use the full exec URL.
  // If you prefer to use the same origin without hardcoding, you can obtain the web app URL server-side.
  // For now, set SCRIPT_URL to the web app's exec URL after you deploy. Example:
  // const SCRIPT_URL = "https://script.google.com/macros/s/XXXXXXXXXXXXX/exec";
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyH5kOEdJGlPgx4sMH3vEqkixalf3X6PACttZHMLWh8M-TtLT2OUN5U_XRMGP-VWAfW/exec"; // this works when served by Apps Script as /macros/s/.../exec

  let currentUser = null;
  let allCardData = [];

  document.addEventListener("DOMContentLoaded", () => {
    // get gretexUser from sessionStorage (if you have login flow that sets it)
    const userString = sessionStorage.getItem("gretexUser");
    if (userString) currentUser = JSON.parse(userString);

    // Wire up modals / buttons / handlers
    document.getElementById('add-new-card-btn').addEventListener('click', () => showModal('add-card-modal'));
    document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', () => closeModal(btn.dataset.close)));
    document.querySelectorAll('.modal-overlay').forEach(overlay => overlay.addEventListener('click', (e) => { if (e.target === overlay) closeModal(overlay.id); }));

    document.getElementById('add-card-form').addEventListener('submit', handleAddCard);
    document.getElementById('add-bill-form').addEventListener('submit', handleAddBill);
    document.getElementById('add-payment-form').addEventListener('submit', handleAddPayment);

    document.getElementById('card-dashboard').addEventListener('click', (e) => {
      if (e.target.classList.contains('btn-add-bill')) {
        document.getElementById('bill-card-id').value = e.target.dataset.cardId;
        showModal('add-bill-modal');
      }
      if (e.target.classList.contains('btn-mark-paid')) {
        document.getElementById('payment-bill-id').value = e.target.dataset.billId;
        document.getElementById('payment-amount').value = e.target.dataset.billAmount;
        showModal('add-payment-modal');
      }
    });

    document.getElementById('bill-attachment').addEventListener('change', (e) => { /* UI only */ });
    document.getElementById('payment-attachment').addEventListener('change', (e) => { /* UI only */ });

    // initial load
    loadDashboard();
  });

  // Modal helpers
  function showModal(id) { document.getElementById(id).classList.add('visible'); }
  function closeModal(id) {
    const m = document.getElementById(id);
    m.classList.remove('visible');
    const form = m.querySelector('form');
    if (form) form.reset();
  }

  // Safe escape helper
  function escapeHtml(s){ if (s === null || s === undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

  // convert file to base64
  function fileToBase64(file){ return new Promise((resolve,reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = (err) => reject(err);
  }); }

  // LOAD DASHBOARD
  async function loadDashboard(){
  showLoading(true);
  // Use google.script.run when the page is served by Apps Script
  google.script.run.withSuccessHandler(function(json){
    showLoading(false);
    if (json && json.status === "success") {
      allCardData = json.data || [];
      renderDashboard(allCardData);
    } else {
      showError((json && json.data && json.data.message) || "Could not load data.");
    }
  }).withFailureHandler(function(err){
    showLoading(false);
    showError("Server error: " + (err && err.message ? err.message : err));
  }).getCreditCardDashboard({ userName: (currentUser && currentUser.name) || "" });
}


  function renderDashboard(cards){
    const dashboard = document.getElementById('card-dashboard'); dashboard.innerHTML = '';
    if (!cards || cards.length === 0) { dashboard.innerHTML = `<div class="no-bills-message">No credit cards found. Click 'Add New Card' to get started.</div>`; return; }
    cards.forEach(card => dashboard.appendChild(createCardModule(card)));
  }

  function createCardModule(card){
    card.bills = card.bills || [];
    const pendingBills = card.bills.filter(b => (b.status || '').toString().toLowerCase().includes('pending'));
    const paidBills = card.bills.filter(b => (b.status || '').toString().toLowerCase().includes('paid'));
    const issuer = card.issuer || card.Issuer || '';
    const last4 = card.last4 || card.Last4 || '';
    const nameOnCard = card.nameOnCard || card.NameOnCard || '';
    const wrapper = document.createElement('div'); wrapper.className = 'card-module';
    wrapper.innerHTML = `
      <div class="card-module-header">
        <div class="credit-card-visual">
          <div class="card-issuer">${escapeHtml(issuer)}</div>
          <div class="card-number">•••• ${escapeHtml(last4)}</div>
          <div class="card-name">${escapeHtml(nameOnCard)}</div>
        </div>
      </div>
      <div class="card-module-body">
        <div class="bill-section">
          <div class="bill-section-header">
            <h3>Pending Bills</h3>
            <button class="btn-secondary btn-add-bill" data-card-id="${card.id}"><span class="material-icons-outlined" style="vertical-align: bottom; margin-right:4px;">add</span>Add Bill</button>
          </div>
          ${renderBillTable(pendingBills,'pending')}
        </div>
        <div class="bill-section">
          <div class="bill-section-header"><h3>Paid Bills</h3></div>
          ${renderBillTable(paidBills,'paid')}
        </div>
      </div>
    `;
    return wrapper;
  }

  function renderBillTable(bills,type){
    if (!bills || bills.length === 0) return `<div class="no-bills-message">No ${type} bills.</div>`;
    let headers = type === 'pending' ? `<th>Bill #</th><th>Bill Date</th><th>Due Date</th><th>Amount</th><th>Actions</th>` : `<th>Bill #</th><th>Bill Date</th><th>Pay Date</th><th>Amount</th><th>Txn #</th>`;
    const rows = bills.map(bill => {
      const billNumber = escapeHtml(bill.billNumber || bill.BillNumber || '');
      const billDate = escapeHtml(bill.billDate || bill.BillDate || '');
      const dueDate = escapeHtml(bill.dueDate || bill.DueDate || '');
      const payDate = escapeHtml(bill.payDate || bill.PayDate || '');
      const txnNo = escapeHtml(bill.txnNo || bill.TxnNo || '');
      const amountNum = (typeof bill.amount === 'number') ? bill.amount : (Number(bill.amount) || 0);
      const payAmountNum = (typeof bill.payAmount === 'number') ? bill.payAmount : (Number(bill.payAmount) || 0);
      if (type === 'pending') {
        return `<tr><td>${billNumber}</td><td>${billDate}</td><td>${dueDate}</td><td class="amount">₹${amountNum.toFixed(2)}</td><td><button class="btn-paid btn-mark-paid" data-bill-id="${bill.id}" data-bill-amount="${amountNum}">Mark as Paid</button></td></tr>`;
      } else {
        return `<tr><td>${billNumber}</td><td>${billDate}</td><td>${payDate}</td><td class="paid-amount">₹${payAmountNum.toFixed(2)}</td><td>${txnNo}</td></tr>`;
      }
    }).join('');
    return `<table class="bill-table"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
  }

  // UI helpers
  function showLoading(is){ const s = document.getElementById('loading-spinner'); if (s) s.style.display = is ? 'block' : 'none'; }
  function showError(msg){ alert(msg); const d = document.getElementById('card-dashboard'); d.innerHTML = `<div class="no-bills-message">${escapeHtml(msg)}</div>`; }

  // ------------------- Form Handlers -------------------
  async function handleAddCard(e){
  e.preventDefault();
  const btn = document.getElementById('save-card-btn');
  btn.disabled = true; btn.textContent = 'Saving...';

  const params = {
    issuer: document.getElementById('card-issuer').value,
    last4: document.getElementById('card-last-4').value,
    nameOnCard: document.getElementById('card-name').value,
    addedBy: (currentUser && currentUser.name) || 'unknown'
  };

  google.script.run.withSuccessHandler(function(json){
    btn.disabled = false; btn.textContent = 'Save Card';
    if (json && json.status === 'success') {
      closeModal('add-card-modal');
      loadDashboard();
    } else {
      alert('Error: ' + (json && json.data && json.data.message ? json.data.message : 'Could not save card'));
    }
  }).withFailureHandler(function(err){
    btn.disabled = false; btn.textContent = 'Save Card';
    alert('Server error: ' + (err && err.message ? err.message : err));
  }).addCreditCard(params);
}


  async function handleAddBill(e){
    e.preventDefault();
    const btn = document.getElementById('save-bill-btn'); btn.disabled = true; btn.textContent = 'Saving...';
    try {
      let attachment = null;
      const fileInput = document.getElementById('bill-attachment');
      if (fileInput && fileInput.files && fileInput.files.length > 0) {
        const f = fileInput.files[0];
        const b64 = await fileToBase64(f);
        attachment = { filename: f.name, mimeType: f.type, data: b64 };
      }
      const payload = { action: "addBill", params: { cardId: document.getElementById('bill-card-id').value, billNumber: document.getElementById('bill-number').value, billDate: document.getElementById('bill-date').value, dueDate: document.getElementById('bill-due-date').value, amount: parseFloat(document.getElementById('bill-amount').value), addedBy: (currentUser && currentUser.name) || 'unknown', attachment } };
      const res = await fetch(SCRIPT_URL, { method:'POST', headers:{ 'Content-Type':'application/json;charset=utf-8' }, body: JSON.stringify(payload) });
      const json = await res.json();
      if (json.status === 'success') { closeModal('add-bill-modal'); await loadDashboard(); }
      else alert('Error: ' + (json.data?.message || 'Could not save bill'));
    } catch (err) { alert('Network Error: ' + err.message); }
    finally { btn.disabled = false; btn.textContent = 'Save Bill'; }
  }

  async function handleAddPayment(e){
    e.preventDefault();
    const btn = document.getElementById('save-payment-btn'); btn.disabled = true; btn.textContent = 'Saving...';
    try {
      let attachment = null;
      const fileInput = document.getElementById('payment-attachment');
      if (fileInput && fileInput.files && fileInput.files.length > 0) {
        const f = fileInput.files[0];
        const b64 = await fileToBase64(f);
        attachment = { filename: f.name, mimeType: f.type, data: b64 };
      }
      const payload = { action: "markBillPaid", params: { billId: document.getElementById('payment-bill-id').value, txnNo: document.getElementById('payment-txn-no').value, payDate: document.getElementById('payment-date').value, payAmount: parseFloat(document.getElementById('payment-amount').value), paidBy: (currentUser && currentUser.name) || 'unknown', attachment } };
      const res = await fetch(SCRIPT_URL, { method:'POST', headers:{ 'Content-Type':'application/json;charset=utf-8' }, body: JSON.stringify(payload) });
      const json = await res.json();
      if (json.status === 'success') { closeModal('add-payment-modal'); await loadDashboard(); }
      else alert('Error: ' + (json.data?.message || 'Could not save payment'));
    } catch (err) { alert('Network Error: ' + err.message); }
    finally { btn.disabled = false; btn.textContent = 'Save Payment'; }
  }
</script>
</body>
</html>
