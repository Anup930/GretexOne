<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <base target="_top">
  <title>Gretex One - Credit Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

  <style>
    :root {
      --purple-1: #3a3f9d;
      --purple-2: #5b6fe0;
      --card-bg: #fdfdff;
      --shadow-med: 0 6px 18px rgba(0,0,0,0.06);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Poppins', sans-serif; background: #f0f4f8; padding: 40px; color: #333; }
    .back-link { font-size: 1rem; text-decoration: none; color: #4a5a9b; font-weight: 500; margin-bottom: 20px; display: inline-block; }
    .app-content { max-width: 1200px; margin: 0 auto; }
    .dashboard-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
    .dashboard-header h1 { font-size:1.8rem; font-weight:600; }
    .btn-primary { background: linear-gradient(90deg, var(--purple-2), var(--purple-1)); color:#fff; border:none; padding:10px 20px; border-radius:8px; font-weight:600; cursor:pointer; }
    .card-module { background: var(--card-bg); border-radius:16px; box-shadow:var(--shadow-med); overflow:hidden; }
    .card-module-header { padding:24px 32px; border-bottom:1px solid #e9eef2; }
    .credit-card-visual { width:300px; height:180px; background: linear-gradient(135deg,#4c5bd6,#384090); border-radius:12px; padding:20px; color:#fff; display:flex; flex-direction:column; justify-content:space-between; box-shadow: 0 10px 30px rgba(50,60,140,0.3); }
    .card-module-body { padding:24px 32px; }
    .bill-section { margin-bottom:24px; }
    .bill-section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .btn-secondary { background:#eef2f7; border:1px solid #d8e0e7; padding:8px 16px; border-radius:6px; cursor:pointer; }
    .btn-paid { background:#e0f2f1; color:#00695c; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }
    .bill-table { width:100%; border-collapse:collapse; font-size:14px; }
    .bill-table th, .bill-table td { padding:12px 16px; text-align:left; border-bottom:1px solid #eef2f7; }
    .no-bills-message { padding:20px; text-align:center; color:#777; background:#f9f9f9; border-radius:8px; }
    .loading-spinner { text-align:center; padding:50px; font-size:1.2rem; color:#555; }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal-overlay.visible { display:flex; }
    .modal-content { background:#fff; border-radius:12px; padding:24px; width:100%; max-width:520px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
    .form-group { margin-bottom:12px; }
    input[type="text"], input[type="number"], input[type="date"], input[type="file"] { padding:8px 10px; border:1px solid #d8e0e7; border-radius:6px; width:100%; }
    .modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .error-note { color: #b00020; font-size: 0.95rem; margin-top: 8px; }
  </style>
</head>
<body>

  <a href="App_access.html" class="back-link">← Back to Home</a>

  <div class="app-content">
    <div class="dashboard-header">
      <h1>Credit Card Management</h1>
      <button class="btn-primary" id="add-new-card-btn">
        <span class="material-icons-outlined" style="vertical-align:middle; margin-right:6px;">add_card</span>
        Add New Card
      </button>
    </div>

    <div id="card-dashboard">
      <div id="loading-spinner" class="loading-spinner">Loading your card dashboard...</div>
    </div>
    <div id="error-info" class="error-note" style="display:none;"></div>
  </div>

  <!-- Add Card Modal -->
  <div class="modal-overlay" id="add-card-modal">
    <div class="modal-content">
      <h2>Add New Credit Card</h2>
      <form id="add-card-form">
        <div class="form-group">
          <label for="card-issuer">Card Issuer (e.g., HDFC Bank)</label>
          <input type="text" id="card-issuer" required>
        </div>
        <div class="form-group">
          <label for="card-last-4">Last 4 Digits</label>
          <input type="text" id="card-last-4" maxlength="4" pattern="\d{4}" required>
        </div>
        <div class="form-group">
          <label for="card-name">Name on Card</label>
          <input type="text" id="card-name" required>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" data-close="add-card-modal">Cancel</button>
          <button type="submit" class="btn-primary" id="save-card-btn">Save Card</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Bill Modal -->
  <div class="modal-overlay" id="add-bill-modal">
    <div class="modal-content">
      <h2>Add New Bill</h2>
      <form id="add-bill-form">
        <input type="hidden" id="bill-card-id">
        <div class="form-group"><label for="bill-number">Bill Number</label><input id="bill-number" required></div>
        <div class="form-group"><label for="bill-date">Bill Date</label><input id="bill-date" type="date" required></div>
        <div class="form-group"><label for="bill-due-date">Due Date</label><input id="bill-due-date" type="date" required></div>
        <div class="form-group"><label for="bill-amount">Amount</label><input id="bill-amount" type="number" step="0.01" required></div>
        <div class="form-group"><label for="bill-attachment">Attachment</label><input id="bill-attachment" type="file" accept=".pdf,image/*"></div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" data-close="add-bill-modal">Cancel</button>
          <button type="submit" class="btn-primary" id="save-bill-btn">Save Bill</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Payment Modal -->
  <div class="modal-overlay" id="add-payment-modal">
    <div class="modal-content">
      <h2>Mark Bill as Paid</h2>
      <form id="add-payment-form">
        <input type="hidden" id="payment-bill-id">
        <div class="form-group"><label for="payment-txn-no">Transaction No.</label><input id="payment-txn-no" required></div>
        <div class="form-group"><label for="payment-date">Pay Date</label><input id="payment-date" type="date" required></div>
        <div class="form-group"><label for="payment-amount">Pay Amount</label><input id="payment-amount" type="number" step="0.01" required></div>
        <div class="form-group"><label for="payment-attachment">Payment Attachment</label><input id="payment-attachment" type="file" accept=".pdf,image/*"></div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" data-close="add-payment-modal">Cancel</button>
          <button type="submit" class="btn-primary" id="save-payment-btn">Save Payment</button>
        </div>
      </form>
    </div>
  </div>

<script>
/*
  NOTE:
  - If hosting on GitHub Pages: change SCRIPT_URL below to your deployed Apps Script exec URL (https://script.google.com/macros/s/AKfy.../exec).
  - If serving from Apps Script web app: open the web app URL (do not open the GitHub page)—the page will use google.script.run automatically.
*/

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyH5kOEdJGlPgx4sMH3vEqkixalf3X6PACttZHMLWh8M-TtLT2OUN5U_XRMGP-VWAfW/exec"; // <--- replace only if hosting on GitHub

const USE_GOOGLE_RUN = (typeof google !== 'undefined' && google && google.script && google.script.run);

let currentUser = null;
let allCardData = [];

document.addEventListener("DOMContentLoaded", () => {
  const userString = sessionStorage.getItem("gretexUser");
  if (!userString) {
    window.location.href = "index.html";
    return;
  }
  currentUser = JSON.parse(userString);

  document.getElementById('add-new-card-btn').addEventListener('click', () => showModal('add-card-modal'));
  document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', () => closeModal(btn.dataset.close)));
  document.querySelectorAll('.modal-overlay').forEach(overlay => overlay.addEventListener('click', (e) => { if (e.target === overlay) closeModal(overlay.id); }));

  document.getElementById('add-card-form').addEventListener('submit', handleAddCard);
  document.getElementById('add-bill-form').addEventListener('submit', handleAddBill);
  document.getElementById('add-payment-form').addEventListener('submit', handleAddPayment);

  document.getElementById('card-dashboard').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    if (btn.classList.contains('btn-add-bill')) {
      document.getElementById('bill-card-id').value = btn.dataset.cardId;
      showModal('add-bill-modal');
    } else if (btn.classList.contains('btn-mark-paid')) {
      document.getElementById('payment-bill-id').value = btn.dataset.billId;
      document.getElementById('payment-amount').value = btn.dataset.billAmount;
      showModal('add-payment-modal');
    }
  });

  loadDashboard();
});

function showModal(id){ document.getElementById(id).classList.add('visible'); }
function closeModal(id){ const m=document.getElementById(id); m.classList.remove('visible'); const f=m.querySelector('form'); if(f) f.reset(); }
function escapeHtml(s){ if (s === null || s === undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function fileToBase64(file){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.readAsDataURL(file); r.onload=()=>resolve(r.result.split(',')[1]); r.onerror=err=>reject(err); }); }
function displayError(msg){ const el=document.getElementById('error-info'); el.style.display='block'; el.textContent = msg; }

function serverCall(action, params){
  if (USE_GOOGLE_RUN) {
    return new Promise((resolve,reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)[action](params);
    });
  } else {
    return fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json;charset=utf-8' },
      body: JSON.stringify({ action, params })
    }).then(async res => {
      const txt = await res.text();
      try { return JSON.parse(txt); }
      catch (err) { throw new Error('Invalid JSON response from server. Response text: ' + txt.slice(0,300)); }
    });
  }
}

async function loadDashboard(){
  showLoading(true);
  document.getElementById('error-info').style.display='none';
  try {
    const json = await serverCall('getCreditCardDashboard', { userName: (currentUser && currentUser.name) || '' });
    if (json && json.status === 'success') {
      allCardData = json.data || [];
      renderDashboard(allCardData);
    } else {
      const msg = (json && json.data && json.data.message) ? json.data.message : 'Could not load data.';
      showError(msg);
    }
  } catch (err) {
    showError('Network/server error: ' + (err && err.message ? err.message : err));
    displayError('If you host this page on GitHub Pages and see CORS errors, either open the Apps Script web app URL (recommended), or use a small proxy that adds Access-Control-Allow-Origin header.');
  } finally {
    showLoading(false);
  }
}

function renderDashboard(cards){
  const d = document.getElementById('card-dashboard'); d.innerHTML = '';
  if (!cards || cards.length === 0) {
    d.innerHTML = `<div class="no-bills-message">No credit cards found. Click 'Add New Card' to get started.</div>`; return;
  }
  cards.forEach(card => d.appendChild(createCardModule(card)));
}

function createCardModule(card){
  card.bills = card.bills || [];
  const pending = card.bills.filter(b => (String(b.status || '').toLowerCase()).includes('pending'));
  const paid = card.bills.filter(b => (String(b.status || '').toLowerCase()).includes('paid'));
  const issuer = card.issuer || card.Issuer || '';
  const last4 = card.last4 || card.Last4 || '';
  const nameOnCard = card.nameOnCard || card.NameOnCard || '';
  const wrap = document.createElement('div'); wrap.className='card-module';
  wrap.innerHTML = `
    <div class="card-module-header">
      <div class="credit-card-visual">
        <div class="card-issuer">${escapeHtml(issuer)}</div>
        <div class="card-number">•••• ${escapeHtml(last4)}</div>
        <div class="card-name">${escapeHtml(nameOnCard)}</div>
      </div>
    </div>
    <div class="card-module-body">
      <div class="bill-section">
        <div class="bill-section-header">
          <h3>Pending Bills</h3>
          <button class="btn-secondary btn-add-bill" data-card-id="${card.id}"> <span class="material-icons-outlined" style="vertical-align: bottom; margin-right:4px;">add</span> Add Bill</button>
        </div>
        ${renderBillTable(pending,'pending')}
      </div>
      <div class="bill-section">
        <div class="bill-section-header"><h3>Paid Bills</h3></div>
        ${renderBillTable(paid,'paid')}
      </div>
    </div>
  `;
  return wrap;
}

function renderBillTable(bills,type){
  if (!bills || bills.length === 0) return `<div class="no-bills-message">No ${type} bills.</div>`;
  let headers = type==='pending' ? `<th>Bill #</th><th>Bill Date</th><th>Due Date</th><th>Amount</th><th>Actions</th>` : `<th>Bill #</th><th>Bill Date</th><th>Pay Date</th><th>Amount</th><th>Txn #</th>`;
  const rows = bills.map(b=>{
    const billNumber = escapeHtml(b.billNumber || b.BillNumber || '');
    const billDate = escapeHtml(b.billDate || b.BillDate || '');
    const dueDate = escapeHtml(b.dueDate || b.DueDate || '');
    const payDate = escapeHtml(b.payDate || b.PayDate || '');
    const txnNo = escapeHtml(b.txnNo || b.TxnNo || '');
    const amount = (typeof b.amount === 'number')? b.amount : (Number(b.amount) || 0);
    const payAmount = (typeof b.payAmount === 'number')? b.payAmount : (Number(b.payAmount) || 0);
    if (type==='pending') {
      return `<tr><td>${billNumber}</td><td>${billDate}</td><td>${dueDate}</td><td class="amount">₹${amount.toFixed(2)}</td><td><button class="btn-paid btn-mark-paid" data-bill-id="${b.id}" data-bill-amount="${amount}">Mark as Paid</button></td></tr>`;
    } else {
      return `<tr><td>${billNumber}</td><td>${billDate}</td><td>${payDate}</td><td class="paid-amount">₹${payAmount.toFixed(2)}</td><td>${txnNo}</td></tr>`;
    }
  }).join('');
  return `<table class="bill-table"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
}

function showLoading(flag){ const s=document.getElementById('loading-spinner'); if (s) s.style.display = flag ? 'block':'none'; }
function showError(message){ alert("Error: "+message); const dashboard=document.getElementById('card-dashboard'); dashboard.innerHTML = `<div class="no-bills-message" style="background:#fff8f8; color:#c00;">${escapeHtml(message)}</div>`; }

async function handleAddCard(e){
  e.preventDefault();
  const btn=document.getElementById('save-card-btn'); btn.disabled=true; btn.textContent='Saving...';
  const params={ issuer: document.getElementById('card-issuer').value, last4: document.getElementById('card-last-4').value, nameOnCard: document.getElementById('card-name').value, addedBy: (currentUser && currentUser.name) || 'unknown' };
  try {
    const json = await serverCall('addCreditCard', params);
    if (json && json.status === 'success') { closeModal('add-card-modal'); await loadDashboard(); }
    else alert('Error: '+(json && json.data && json.data.message ? json.data.message : 'Could not save card'));
  } catch (err) { alert('Server error: '+(err && err.message ? err.message : err)); }
  finally { btn.disabled=false; btn.textContent='Save Card'; }
}

async function handleAddBill(e){
  e.preventDefault();
  const btn=document.getElementById('save-bill-btn'); btn.disabled=true; btn.textContent='Saving...';
  try {
    let attachment=null;
    const f=document.getElementById('bill-attachment');
    if (f && f.files && f.files.length>0) { const b64 = await fileToBase64(f.files[0]); attachment = { filename: f.files[0].name, mimeType: f.files[0].type, data: b64 }; }
    const params = {
      cardId: document.getElementById('bill-card-id').value,
      billNumber: document.getElementById('bill-number').value,
      billDate: document.getElementById('bill-date').value,
      dueDate: document.getElementById('bill-due-date').value,
      amount: parseFloat(document.getElementById('bill-amount').value),
      addedBy: (currentUser && currentUser.name) || 'unknown',
      attachment
    };
    const json = await serverCall('addBill', params);
    if (json && json.status === 'success') { closeModal('add-bill-modal'); await loadDashboard(); }
    else alert('Error: '+(json && json.data && json.data.message ? json.data.message : 'Could not save bill'));
  } catch (err) { alert('Server error: '+(err && err.message ? err.message : err)); }
  finally { btn.disabled=false; btn.textContent='Save Bill'; }
}

async function handleAddPayment(e){
  e.preventDefault();
  const btn=document.getElementById('save-payment-btn'); btn.disabled=true; btn.textContent='Saving...';
  try {
    let attachment=null;
    const f=document.getElementById('payment-attachment');
    if (f && f.files && f.files.length>0) { const b64 = await fileToBase64(f.files[0]); attachment = { filename: f.files[0].name, mimeType: f.files[0].type, data: b64 }; }
    const params = {
      billId: document.getElementById('payment-bill-id').value,
      txnNo: document.getElementById('payment-txn-no').value,
      payDate: document.getElementById('payment-date').value,
      payAmount: parseFloat(document.getElementById('payment-amount').value),
      paidBy: (currentUser && currentUser.name) || 'unknown',
      attachment
    };
    const json = await serverCall('markBillPaid', params);
    if (json && json.status === 'success') { closeModal('add-payment-modal'); await loadDashboard(); }
    else alert('Error: '+(json && json.data && json.data.message ? json.data.message : 'Could not save payment'));
  } catch (err) { alert('Server error: '+(err && err.message ? err.message : err)); }
  finally { btn.disabled=false; btn.textContent='Save Payment'; }
}
</script>
</body>
</html>
